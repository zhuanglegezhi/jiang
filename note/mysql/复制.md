### Mysql 主从复制

#### 原理

1. 主节点 binary log dump 线程
   当从节点连接主节点时，主节点会创建一个`log dump 线程`，用于发送bin-log的内容。在读取bin-log中的操作时，此线程会对主节点上的bin-log加锁，当读取完成，甚至在发动给从节点之前，锁会被释放。

2. 从节点I/O线程
   当从节点上执行`start slave`命令之后，从节点会创建一个`I/O线程`用来连接主节点，请求主库中更新的bin-log。I/O线程接收到主节点binlog dump 进程发来的更新之后，保存在本地relay-log中。

3. 从节点SQL线程
   `SQL线程`负责读取relay log中的内容，解析成具体的操作并执行，最终保证主从数据的一致性。

对于每一个主从连接，都需要三个进程来完成。当主节点有多个从节点时，主节点会为每一个当前连接的从节点建一个binary log dump 进程，而每个从节点都有自己的I/O进程，SQL进程。从节点用两个线程将从主库拉取更新和执行分成独立的任务，这样在执行同步数据任务的时候，不会降低读操作的性能。比如，如果从节点没有运行，此时I/O进程可以很快从主节点获取更新，尽管SQL进程还没有执行。如果在SQL进程执行之前从节点服务停止，至少I/O进程已经从主节点拉取到了最新的变更并且保存在本地relay日志中，当服务再次起来之后，就可以完成数据的同步。



#### 过程

1. 从节点上的I/O 进程连接主节点，并请求从指定日志文件的指定位置（或者从最开始的日志）之后的日志内容；

2. 主节点接收到来自从节点的I/O请求后，通过负责复制的`I/O进程`根据请求信息读取指定日志指定位置之后的日志信息，返回给从节点。返回信息中除了日志所包含的信息之外，还包括本次返回的信息的bin-log file 的以及bin-log position；
3. 从节点的I/O进程接收到内容后，将接收到的日志内容更新到本机的`relay log`中，并将读取到的binary log文件名和位置保存到master-info 文件中，以便在下一次读取的时候能够清楚的告诉Master“我需要从某个bin-log 的哪个位置开始往后的日志内容，请发给我”；
4. Slave 的 `SQL线程`检测到relay-log 中新增加了内容后，会将relay-log的内容解析成在主节点上实际执行过的操作，并在本数据库中执行。


主从复制.jpg![主从复制](https://user-images.githubusercontent.com/17567449/123618030-663e6500-d83a-11eb-991c-d7441288c3fd.jpg)

refer：https://www.cnblogs.com/rickiyang/p/13856388.html
