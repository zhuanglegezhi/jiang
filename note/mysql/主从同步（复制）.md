## 原因

1. 数据容灾、备份。当我们的数据库只使用一台服务时，如果我们的数据库遭到破坏，例如黑客的攻击、人为操作的失误等等情况。这时候我们就可以在一定程度上**保障我们数据库的恢复**。
2. 缓解 MySQL 主服务的压力。当我们线上应用用户量小的时候，所有的读与写操作都在一台服务器上，这时候还不会遇到什么问题。当用户量逐渐增加，访问数据库的请求也越来越多，这时候就给 MySQL 服务器增加了负担，容易导致服务崩溃等问题。因此，主从复制模式可以缓解单服务器的压力，将写操作给主服务器，读操作给从服务器，从服务器可以部署多台，分摊压力。因为在一个应用中，读的操作肯定是大于写的操作。


![截屏2021-10-31 16.21.13](/Users/zz/Library/Application Support/typora-user-images/截屏2021-10-31 16.21.13.png)





## 原理
主从复制.jpg![主从复制](https://user-images.githubusercontent.com/17567449/123618030-663e6500-d83a-11eb-991c-d7441288c3fd.jpg)


#### 三个线程
1. **主节点 log dump 线程**
   当从节点连接主节点时，主节点会创建一个`log dump 线程`，用于发送bin-log的内容。在读取bin-log中的操作时，此线程会对主节点上的bin-log加锁，当读取完成，在发送给从节点之前，锁会被释放。**主节点会为自己的每一个从节点创建一个 log dump 线程**。
   
   
   
2. **从节点I/O线程**
   当从节点上执行`start slave`命令之后，从节点会创建一个`I/O线程`用来连接主节点，请求主库中更新的bin-log。I/O线程接收到主节点binlog dump 进程发来的更新之后，保存在本地relay-log中。

   

3. **从节点SQL线程**
   `SQL线程`负责读取relay log中的内容，解析成具体的操作并执行，最终保证主从数据的一致性。



#### relay log

>这里又引申出一个新的日志概念。MySQL 进行主主复制或主从复制的时候会在要复制的服务器下面产生相应的 relay log。
>
>relay log 是怎么产生的呢？
>
>从服务器 I/O 线程将主服务器的 Binlog 日志读取过来，解析到各类 Events 之后记录到从服务器本地文件，这个文件就被称为 relay log。然后 SQL 线程会读取 relay log 日志的内容并应用到从服务器，从而使从服务器和主服务器的数据保持一致。中继日志充当缓冲区，这样 master 就不必等待 slave 执行完成才发送下一个事件。



- 对于每一个主从连接，都需要三个进程来完成。当主节点有多个从节点时，**主节点会为每一个当前连接的从节点建一个binary log dump 进程**，而每个从节点都有自己的I/O进程，SQL进程。

- 从节点用两个线程将从主库拉取更新和执行分成独立的任务，这样在执行同步数据任务的时候，不会降低读操作的性能。比如，如果从节点没有运行，此时I/O进程可以很快从主节点获取更新，尽管SQL进程还没有执行。如果在SQL进程执行之前从节点服务停止，至少I/O进程已经从主节点拉取到了最新的变更并且保存在本地relay日志中，当服务再次起来之后，就可以完成数据的同步。

- 要实施复制，首先必须打开 Master 端的 Binlog 功能，否则无法实现。

- 因为整个复制过程实际上就是 Slave 从 Master 端获取该日志然后再在自己身上完全顺序的执行日志中所记录的各种操作。如下图所示：

  ![5](https://tva1.sinaimg.cn/large/007S8ZIlgy1gjx1mvsnp5j31040iyad2.jpg)



#### 复制的基本过程


1. 在从节点上执行 `sart slave` 命令开启主从复制开关，开始进行主从复制。从节点上的 I/O 进程连接主节点，并请求从指定日志文件的指定位置（或者从最开始的日志）之后的日志内容。
2. 主节点接收到来自从节点的 I/O 请求后，通过负责复制的 I/O 进程（log Dump Thread）根据请求信息读取指定日志指定位置之后的日志信息，返回给从节点。返回信息中除了日志所包含的信息之外，还包括本次返回的信息的 Binlog file 以及 Binlog position（Binlog 下一个数据读取位置）。
3. 从节点的 I/O 进程接收到主节点发送过来的日志内容、日志文件及位置点后，将接收到的日志内容更新到本机的 relay log 文件（Mysql-relay-bin.xxx）的最末端，并将读取到的 Binlog文件名和位置保存到`master-info` 文件中，以便在下一次读取的时候能够清楚的告诉 Master ：“ 我需要从哪个 Binlog 的哪个位置开始往后的日志内容，请发给我”。
4. Slave 的 SQL 线程检测到relay log 中新增加了内容后，会将 relay log 的内容解析成在能够执行 SQL 语句，然后在本数据库中按照解析出来的顺序执行，并在 `relay log.info` 中记录当前应用中继日志的文件名和位置点。





## 主从复制的模式

![截屏2021-10-31 16.32.04](/Users/zz/Library/Application Support/typora-user-images/截屏2021-10-31 16.32.04.png)

#### 1.异步模式（默认策略）

这种模式下，主节点不会主动推送数据到从节点，主库在执行完客户端提交的事务后会立即将结果返给给客户端，并不关心从库是否已经接收并处理，这样就会有一个问题，主节点如果崩溃掉了，此时主节点上已经提交的事务可能并没有传到从节点上，如果此时，强行将从提升为主，可能导致新主节点上的数据不完整。



#### 2.半同步模式

介于异步复制和全同步复制之间，主库在执行完客户端提交的事务后不是立刻返回给客户端，而是等待至少一个从库接收到并写到 relay log 中才返回成功信息给客户端（只能保证主库的 Binlog 至少传输到了一个从节点上），否则需要等待直到超时时间然后切换成异步模式再提交。



#### 3.全同步模式

指当主库执行完一个事务，然后所有的从库都复制了该事务并成功执行完才返回成功信息给客户端。因为需要等待所有从库执行完该事务才能返回成功信息，所以全同步复制的性能必然会收到严重的影响。



#### 异步同步 VS 半同步

异步同步模式，是直接返回给客户端在处理 slave 的问题，如果 master 响应给客户端成功信息，在处理 slave 问题时，服务挂掉了，此时就会出现数据不一致。

半同步模式，需要等待 slave 节点做出响应，master 才会响应客户端，如果 salve 响应较慢就会造成客户端等待时间较长。

半同步模式，master 等待 slave 响应之后才会响应给客户端，此方式极大程度的保证了数据的一致性，为主从复制的数据一致性提供了更可靠的保证。也推荐使用该方式进行主从复制操作。



Refer

>https://learnku.com/articles/57154
>
>https://www.cnblogs.com/rickiyang/p/13856388.html
